"use strict";!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.echoD=t():e.echoD=t()}("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,(()=>(Object("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).webpackChunkechoD=Object("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).webpackChunkechoD||[]).push([[816],{570:(e,t,n)=>{n.a(e,(async(e,o)=>{try{n.r(t),n.d(t,{BitECSStorage:()=>w,defaultGetGroupedValue:()=>m,defaultSetGroupedValue:()=>b});var r=n(192),s=n(699),i=n(174),l=n(464);const{createWorld:a,defineComponent:u,removeComponent:c,removeEntity:y,entityExists:d,addEntity:f,addComponent:h,getEntityComponents:p}=await Promise.resolve().then(n.bind(n,192));function m(e,t,n,o){const r=n[o];return Array.isArray(r)?e.slice(t*r[1],(t+1)*r[1]):e[t]}function b(e,t,n){return e}class w extends s.Ke{constructor(e,t){super({...e||{},actors:new Map,components:new Map,entities:new Map,inputs:null},t);for(let e in this.types){const t=this.types[e];if("string"==typeof t[0])this.components.set(e,t[2]||u(t[3],t[4]));else switch(t){case Boolean:case Number:case String:this.components.set(e,new Map)}}let{worldOptions:n}=t;this.worldOptions=n,this.world=e?.world||a(),this.eids=e?.eids||new Map}destroyActor(e){return this.destroyId(this.actors,e)}destroyComponent(e,t){const n=this.getEID(e),o=this.components.get(t);if(null==n||!o)return;const s=()=>{const r=this.fetchComponentProcess(e,t,o,n);if(this.indexes[t]){const n=this.indexes[t];this.isActor(e)?n.actors.remove(e,r):n.entities.remove(e,r)}};o instanceof Map?(o.has(n)&&o.delete(n),s()):(d(this.world,n)&&(0,r.tu)(this.world,o,n)&&c(this.world,o,n),s())}destroyEntity(e){return this.destroyId(this.entities,e)}destroyId(e,t){const n=e.get(t);return null!=n&&(d(this.world,n)&&y(this.world,n),e.has(t)&&e.delete(t),!0)}fetchComponents(e){const t=this.getEID(e);if(null==t)return t}fetchComponent(e,t){return this.fetchComponentProcess(e,t,void 0,void 0)}fetchComponentProcess(e,t,n,o){if(o=null==o?this.getEID(e):o,n=n||this.components.get(t),null==o&&n){if(n instanceof Map)return n.get(o);{const e=this.types[t],r=e[3],s=new(i.X.get(e[0]))(e[1]);let l=0;for(let e in r)s[l]=n[e][o],l++;return s}}}getActors(e=null,t){if(null!==e)return super.getActors(e,t);const n=this.actors.keys();return(0,l.paginate)(n,t)}getComponents(e=null,t){let n;n=null!==e?e:[...this.actors.keys(),...this.entities.keys()];const o=(0,l.paginate)(n,t),r=this.components.entries(),s=new Map;for(let[e,t]of r)s.set(t,e);return o.map((e=>{const t={};for(let n of e){const e=this.getEID(n);if(null==e)continue;const o={};p(this.world,e).forEach((t=>{const n=s.get(t);if(!n)return;let r;if(t instanceof Map)r=t.get(e);else{const o=this.types[n],s=o[3],l=new(i.X.get(o[0]))(o[1]);let a=0;for(let n in s)l[a]=t[n][e],a++;r=l}o[n]=r})),t[n]=o}return t}))}getEntities(e=null,t){if(null!==e)return super.getEntities(e,t);const n=this.entities.keys();return(0,l.paginate)(n,t)}getInputs(e=null,t){return super.getInputs(e,t)}getEID(e){return this.actors.has(e)?this.actors.get(e):this.entities.has(e)?this.entities.get(e):void 0}isActor(e){return this.actors.has(e)}isEntity(e){return this.entities.has(e)}setActors(e){return super.setActors(e)}setComponents(e){return super.setComponents(e)}setEntities(e){return super.setEntities(e)}setInputs(e){return super.setInputs(e)}storeActor(e){return this.storeId(this.actors,e)}storeComponent(e,t,n){let o=this.getEID(e);if(null!=o){d(this.world,o)||(o=f(this.world),this.isActor(e)?this.actors.set(e,o):this.entities.set(e,o));const s=this.components.get(t);if(!s)return;(0,r.tu)(this.world,s,o)||h(this.world,s,o);let i=[];if(s instanceof Map)i=s.get(o),s.set(o,n);else{const e=this.types[t][3];let r=0;for(let t in e)i[r]=s[t][o],s[t][o]=n[r],r++}if(this.indexes[t]){const o=this.indexes[t];this.isActor(e)?(o.actors.remove(e,i),o.actors.set(e,n)):(o.entities.remove(e,i),o.entities.set(e,n))}}}storeEntity(e){return this.storeId(this.entities,e)}storeId(e,t){let n=e.get(t);return(null==n&&null==n||!d(this.world,n))&&(n=f(this.world),e.set(t,n),!0)}storeInput(e,t,n=0){return super.storeInput(e,t,n)}}o()}catch(S){o(S)}}),1)},192:(e,t,n)=>{n.d(t,{addComponent:()=>ie,addEntity:()=>z,createWorld:()=>pe,defineComponent:()=>re,entityExists:()=>V,getEntityComponents:()=>G,removeComponent:()=>le,removeEntity:()=>L,tu:()=>se});var o="ui8",r="ui16",s="ui32",i="eid",l={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},a={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},u=(4,e=>4*Math.ceil(e/4)),c=Symbol("storeRef"),y=Symbol("storeSize"),d=Symbol("storeMaps"),f=Symbol("storeFlattened"),h=Symbol("storeBase"),p=Symbol("storeType"),m=Symbol("storeArrayElementCounts"),b=Symbol("storeSubarrays"),w=Symbol("subarrayCursors"),S=Symbol("subarray"),g=(Symbol("subarrayFrom"),Symbol("subarrayTo"),Symbol("parentArray")),E=Symbol("tagStore"),C=(Symbol("queryShadow"),Symbol("serializeShadow"),Symbol("indexType")),A=Symbol("indexBytes"),v=Symbol("isEidType"),I={},M=(e,t)=>{e[f]&&e[f].forEach((e=>{ArrayBuffer.isView(e)?e[t]=0:e[t].fill(0)}))},x=e=>Array.isArray(e)&&"string"==typeof e[0]&&"number"==typeof e[1],k=()=>{const e=[],t=[];e.sort=function(n){const o=Array.prototype.sort.call(this,n);for(let n=0;n<e.length;n++)t[e[n]]=n;return o};const n=n=>e[t[n]]===n;return{add:o=>{n(o)||(t[o]=e.push(o)-1)},remove:o=>{if(!n(o))return;const r=t[o],s=e.pop();s!==o&&(e[r]=s,t[s]=r)},has:n,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},j=e=>t=>!e(t),O=(j((e=>e[f])),e=>"function"==typeof e&&e[Y]),U=(j(O),Symbol("entityMasks")),T=Symbol("entityComponents"),q=Symbol("entitySparseSet"),D=Symbol("entityArray"),R=(Symbol("entityIndices"),Symbol("removedEntities"),1e5),B=0,N=R,P=()=>N,Q=[],F=[],_=new Map,z=e=>{const t=e[fe]?Q.length?Q.shift():B++:Q.length>Math.round(.01*N)?Q.shift():B++;if(t>e[ae])throw new Error("bitECS - max entities reached");return e[q].add(t),_.set(t,e),e[J].forEach((n=>{Z(e,n,t)&&ee(n,t)})),e[T].set(t,new Set),t},L=(e,t)=>{if(e[q].has(t)){e[$].forEach((n=>{te(e,n,t)})),e[fe]?F.push(t):Q.push(t),e[q].remove(t),e[T].delete(t),e[ye].delete(e[de].get(t)),e[de].delete(t);for(let n=0;n<e[U].length;n++)e[U][n][t]=0}},G=(e,t)=>{if(void 0===t)throw new Error("bitECS - entity is undefined.");if(!e[q].has(t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(e[T].get(t))},V=(e,t)=>e[q].has(t),Y=Symbol("$modifier"),$=Symbol("queries"),J=Symbol("notQueries"),W=(Symbol("queryAny"),Symbol("queryAll"),Symbol("queryNone"),Symbol("queryMap")),X=Symbol("$dirtyQueries"),K=(Symbol("queryComponents"),Symbol("enterQuery"),Symbol("exitQuery"),Object.freeze([]),(e,t)=>e.concat(t)),H=e=>t=>t.filter((t=>t.name===e().constructor.name)).reduce(K),Z=(H((function(...e){return function(){return e}})),H((function(...e){return function(){return e}})),H((function(...e){return function(){return e}})),(e,t,n)=>{const{masks:o,notMasks:r,generations:s}=t;for(let t=0;t<s.length;t++){const i=s[t],l=o[i],a=r[i],u=e[U][i][n];if(a&&0!=(u&a))return!1;if(l&&(u&l)!==l)return!1}return!0}),ee=(e,t)=>{e.toRemove.remove(t),e.entered.add(t),e.add(t)},te=(e,t,n)=>{t.has(n)&&!t.toRemove.has(n)&&(t.toRemove.add(n),e[X].add(t),t.exited.add(n))},ne=Symbol("componentMap"),oe=[],re=(e,t)=>{const n=((e,t)=>{const n=Symbol("store");if(!e||!Object.keys(e).length)return I[n]={[y]:t,[E]:!0,[h]:()=>I[n]},I[n];e=JSON.parse(JSON.stringify(e));const M={},k=e=>{const t=Object.keys(e);for(const n of t)x(e[n])?(M[e[n][0]]||(M[e[n][0]]=0),M[e[n][0]]+=e[n][1]):e[n]instanceof Object&&k(e[n])};k(e);const j={[y]:t,[d]:{},[b]:{},[c]:n,[w]:Object.keys(a).reduce(((e,t)=>({...e,[t]:0})),{}),[f]:[],[m]:M};if(e instanceof Object&&Object.keys(e).length){const c=(e,d)=>{if("string"==typeof e[d])e[d]=((e,t)=>{const n=t*a[e].BYTES_PER_ELEMENT,o=new ArrayBuffer(n),r=new a[e](o);return r[v]=e===i,r})(e[d],t),e[d][h]=()=>I[n],j[f].push(e[d]);else if(x(e[d])){const[t,c]=e[d];e[d]=((e,t,n)=>{const c=e[y],d=Array(c).fill(0);d[p]=t,d[v]=t===i;const f=e[w],h=n<=256?o:n<=65536?r:s;if(!n)throw new Error("bitECS - Must define component array length");if(!a[t])throw new Error(`bitECS - Invalid component array property type ${t}`);if(!e[b][t]){const n=e[m][t],o=new a[t](u(n*c));o[C]=l[h],o[A]=a[h].BYTES_PER_ELEMENT,e[b][t]=o}const E=f[t],I=E+c*n;f[t]=I,d[g]=e[b][t].subarray(E,I);for(let e=0;e<c;e++){const t=n*e,o=t+n;d[e]=d[g].subarray(t,o),d[e][C]=l[h],d[e][A]=a[h].BYTES_PER_ELEMENT,d[e][S]=!0}return d})(j,t,c),e[d][h]=()=>I[n],j[f].push(e[d])}else e[d]instanceof Object&&(e[d]=Object.keys(e[d]).reduce(c,e[d]));return e};return I[n]=Object.assign(Object.keys(e).reduce(c,e),j),I[n][h]=()=>I[n],I[n]}})(e,t||P());return e&&Object.keys(e).length&&oe.push(n),n},se=(e,t,n)=>{const o=e[ne].get(t);if(!o)return!1;const{generationId:r,bitflag:s}=o;return(e[U][r][n]&s)===s},ie=(e,t,n,o=!1)=>{if(void 0===n)throw new Error("bitECS - entity is undefined.");if(!e[q].has(n))throw new Error("bitECS - entity does not exist in the world.");if(e[ne].has(t)||((e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");const n=new Set,o=new Set,r=new Set;e[$].forEach((e=>{e.allComponents.includes(t)&&n.add(e)})),e[ne].set(t,{generationId:e[U].length-1,bitflag:e[ue],store:t,queries:n,notQueries:o,changedQueries:r}),(e=>{e[ue]*=2,e[ue]>=2**31&&(e[ue]=1,e[U].push(new Uint32Array(e[ae])))})(e)})(e,t),se(e,t,n))return;const r=e[ne].get(t),{generationId:s,bitflag:i,queries:l,notQueries:a}=r;e[U][s][n]|=i,l.forEach((t=>{t.toRemove.remove(n);const o=Z(e,t,n);o&&(t.exited.remove(n),ee(t,n)),o||(t.entered.remove(n),te(e,t,n))})),e[T].get(n).add(t),o&&M(t,n)},le=(e,t,n,o=!0)=>{if(void 0===n)throw new Error("bitECS - entity is undefined.");if(!e[q].has(n))throw new Error("bitECS - entity does not exist in the world.");if(!se(e,t,n))return;const r=e[ne].get(t),{generationId:s,bitflag:i,queries:l}=r;e[U][s][n]&=~i,l.forEach((t=>{t.toRemove.remove(n);const o=Z(e,t,n);o&&(t.exited.remove(n),ee(t,n)),o||(t.entered.remove(n),te(e,t,n))})),e[T].get(n).delete(t),o&&M(t,n)},ae=Symbol("size"),ue=(Symbol("resizeThreshold"),Symbol("bitflag")),ce=Symbol("archetypes"),ye=Symbol("localEntities"),de=Symbol("localEntityLookup"),fe=Symbol("manualEntityRecycling"),he=[],pe=(...e)=>{const t="object"==typeof e[0]?e[0]:{},n="number"==typeof e[0]?e[0]:"number"==typeof e[1]?e[1]:P();return me(t,n),he.push(t),t},me=(e,t=P())=>(e[ae]=t,e[D]&&e[D].forEach((t=>L(e,t))),e[U]=[new Uint32Array(t)],e[T]=new Map,e[ce]=[],e[q]=k(),e[D]=e[q].dense,e[ue]=1,e[ne]=new Map,e[W]=new Map,e[$]=new Set,e[J]=new Set,e[X]=new Set,e[ye]=new Map,e[de]=new Map,e[fe]=!1,e)}},e=>(570,e(e.s=570))])));
//# sourceMappingURL=bitecs.echo-d.min.js.map